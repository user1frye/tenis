<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tenis Oyunu - Asena vs Emre (Robot)</title>
  <style>
    :root { color-scheme: dark; }
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:#0b1220; color:#e6edf3;
    }
    .wrap{
      width:min(920px, 94vw);
      background:#101a30;
      border:1px solid #223055;
      border-radius:18px;
      padding:16px;
      box-shadow:0 12px 40px rgba(0,0,0,.35);
    }
    .top{
      display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-bottom:10px;
    }
    .title{ font-size:18px; font-weight:800; letter-spacing:.2px; }
    .hint{ opacity:.85; font-size:13px; }
    canvas{
      width:100%; height:auto; display:block;
      background:#050a14;
      border:1px solid #223055;
      border-radius:14px;
    }
    .bar{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between;
      margin-top:10px;
    }
    .pill{
      padding:8px 12px;
      border:1px solid #2b3c6a;
      background:#0e1730;
      border-radius:999px;
      font-weight:650;
    }
    .btn{
      cursor:pointer;
      padding:10px 14px;
      border-radius:12px;
      border:1px solid #2b3c6a;
      background:#162344;
      color:#e6edf3;
      font-weight:700;
    }
    .btn:active{ transform: translateY(1px); }
    #toast{
      margin-top:10px;
      min-height:22px;
      font-weight:800;
      letter-spacing:.2px;
      opacity:.95;
      text-align:center;
    }
    kbd{
      border:1px solid #2b3c6a; border-bottom-width:3px;
      padding:1px 6px; border-radius:6px; background:#0e1730;
      font-weight:700; font-size:12px;
    }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div class="title">Tenis (Pong): Asena (Sen) vs Emre (Robot) — 5 sayıya ilk ulaşan kazanır</div>
      <div class="hint">Kontrol: <kbd>W</kbd>/<kbd>S</kbd> veya <kbd>↑</kbd>/<kbd>↓</kbd> · Boşluk: Başlat/Durdur</div>
    </div>

    <canvas id="game" width="900" height="520"></canvas>

    <div class="bar">
      <div class="pill">Asena: <span id="sLeft">0</span> / 5</div>
      <div class="pill">Emre (Robot): <span id="sRight">0</span> / 5</div>
      <button class="btn" id="reset">Yeniden Başlat</button>
    </div>

    <div id="toast"></div>
  </div>

<script>
(() => {
  const c = document.getElementById("game");
  const ctx = c.getContext("2d");

  const sLeftEl  = document.getElementById("sLeft");
  const sRightEl = document.getElementById("sRight");
  const toastEl  = document.getElementById("toast");
  const resetBtn = document.getElementById("reset");

  const W = c.width, H = c.height;

  // === AYARLAR ===
  const WIN_SCORE = 5;

  const paddleW = 14, paddleH = 110;
  const leftX  = 40;
  const rightX = W - 40 - paddleW;

  const netW = 6;
  const netGap = 12;
  const ballR = 9;

  // ZORLUK: Emre güçlü
  const playerSpeed = 520;        // senin hızın
  const aiMaxSpeed  = 820;        // robot daha hızlı
  const aiReaction  = 0.09;       // küçük = daha hızlı tepki (zor)
  const aiAimError  = 2;          // küçük = daha isabetli (zor)

  // Top hızları
  let ballBaseSpeed = 620;        // başlangıç
  const ballMaxSpeed = 1250;

  // Ralli uzadıkça hızlanma (SAYI OLMADAN)
  const rallySpeedEverySec = 1.4; // her 2.2 saniyede bir hız artışı
  const rallySpeedAdd = 34;       // artış miktarı

  let left = { y: H/2 - paddleH/2, vy: 0 };
  let right = { y: H/2 - paddleH/2, vy: 0 };

  let ball;
  let running = true;
  let gameOver = false;

  let scoreL = 0, scoreR = 0;

  // Ralli takibi
  let rallyTime = 0;
  let lastRallyBoostAt = 0;

  function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

  function toast(msg){
    toastEl.textContent = msg;
    if (msg){
      clearTimeout(toast._t);
      toast._t = setTimeout(() => { if(!gameOver) toastEl.textContent = ""; }, 1200);
    }
  }

  function resetBall(direction){
    // direction: +1 sağa, -1 sola
    const angle = (Math.random() * 0.9 - 0.45); // -0.45..0.45 rad
    const speed = ballBaseSpeed;
    ball = {
      x: W/2, y: H/2,
      vx: Math.cos(angle) * speed * direction,
      vy: Math.sin(angle) * speed
    };
    // yeni ralli
    rallyTime = 0;
    lastRallyBoostAt = 0;
  }

  function fullReset(){
    scoreL = 0; scoreR = 0;
    ballBaseSpeed = 460;
    left.y = H/2 - paddleH/2;
    right.y = H/2 - paddleH/2;
    sLeftEl.textContent = scoreL;
    sRightEl.textContent = scoreR;
    gameOver = false;
    running = true;
    toast("");
    resetBall(Math.random() < 0.5 ? 1 : -1);
  }

  function endGame(winner){
    gameOver = true;
    running = false;
    toast(`${winner} kazandı!`);
  }

  function drawCourt(){
    ctx.clearRect(0,0,W,H);

    ctx.globalAlpha = 0.9;
    ctx.strokeStyle = "#223055";
    ctx.lineWidth = 3;
    ctx.strokeRect(10,10,W-20,H-20);

    ctx.globalAlpha = 0.8;
    ctx.fillStyle = "#2b3c6a";
    for (let y=20; y<H-20; y += netGap){
      ctx.fillRect(W/2 - netW/2, y, netW, netGap/2);
    }

    ctx.globalAlpha = 0.12;
    ctx.beginPath();
    ctx.moveTo(W/2, 20);
    ctx.lineTo(W/2, H-20);
    ctx.strokeStyle = "#8ab4ff";
    ctx.lineWidth = 2;
    ctx.stroke();
    ctx.globalAlpha = 1;
  }

  function drawPaddles(){
    ctx.fillStyle = "#8fffbc"; // Asena
    ctx.fillRect(leftX, left.y, paddleW, paddleH);

    ctx.fillStyle = "#ffb86b"; // Emre robot
    ctx.fillRect(rightX, right.y, paddleW, paddleH);
  }

  function drawBall(){
    ctx.beginPath();
    ctx.arc(ball.x, ball.y, ballR, 0, Math.PI*2);
    ctx.fillStyle = "#e6edf3";
    ctx.fill();
  }

  function overlayGameOver(){
    if (!gameOver) return;

    ctx.fillStyle = "rgba(0,0,0,0.55)";
    ctx.fillRect(0,0,W,H);

    const winner = scoreL >= WIN_SCORE ? "Asena" : "Emre";
    ctx.fillStyle = "#e6edf3";
    ctx.textAlign = "center";

    ctx.font = "800 44px system-ui";
    ctx.fillText(`${winner} KAZANDI!`, W/2, H/2 - 10);

    ctx.font = "600 18px system-ui";
    ctx.fillText("Yeniden başlatmak için alttaki butona bas", W/2, H/2 + 28);
  }

  function reflectFromPaddle(paddleY, isLeft){
    const paddleCenter = paddleY + paddleH/2;
    const dy = (ball.y - paddleCenter) / (paddleH/2); // -1..1
    const maxAngle = 1.05;
    const angle = dy * maxAngle;

    // çarpınca hız biraz artsın
    const currentSpeed = Math.hypot(ball.vx, ball.vy);
    const speed = Math.min(ballMaxSpeed, currentSpeed * 1.04);

    const dir = isLeft ? +1 : -1;
    ball.vx = Math.cos(angle) * speed * dir;
    ball.vy = Math.sin(angle) * speed;

    // küçük spin
    ball.vy += (isLeft ? left.vy : right.vy) * 0.07;

    // ralli devam ediyor -> ralli süresi sıfırlanmaz, hızlanma oradan gidecek
  }

  // Kontroller
  const keys = new Set();
  window.addEventListener("keydown", (e) => {
    const k = e.key.toLowerCase();
    keys.add(k);
    if (k === " " && !gameOver) {
      running = !running;
      toast(running ? "Devam" : "Durdu");
    }
  });
  window.addEventListener("keyup", (e) => keys.delete(e.key.toLowerCase()));

  resetBtn.addEventListener("click", fullReset);

  function updatePlayer(dt){
    let dir = 0;
    if (keys.has("w") || keys.has("arrowup")) dir -= 1;
    if (keys.has("s") || keys.has("arrowdown")) dir += 1;

    left.vy = dir * playerSpeed;
    left.y += left.vy * dt;
    left.y = clamp(left.y, 20, H - 20 - paddleH);
  }

  // Robot: topun sağ tarafa geleceği yeri daha iyi tahmin eder
  function predictBallYAtX(targetX){
    // Top sağa gidiyorsa tahmin yapalım, sola gidiyorsa direkt mevcut y
    if (ball.vx <= 0) return ball.y;

    // Basit sim: yansımaları hesaba katarak (üst/alt)
    let x = ball.x, y = ball.y;
    let vx = ball.vx, vy = ball.vy;

    // çok uzun sim olmasın
    for (let i=0; i<1200; i++){
      const t = 1; // küçük adım
      x += vx * 0.002;
      y += vy * 0.002;

      if (y - ballR <= 20) { y = 20 + ballR; vy *= -1; }
      if (y + ballR >= H - 20) { y = (H - 20) - ballR; vy *= -1; }

      if (x >= targetX) return y;
    }
    return ball.y;
  }

  let aiMemoryY = H/2;
  function updateAI(dt){
    // hedef: topun sağ rakete geleceği y (tahmin)
    const targetY = predictBallYAtX(rightX);
    // insan gibi küçük tepki gecikmesi: hedefi biraz yumuşat
    aiMemoryY += (targetY - aiMemoryY) * (1 - Math.exp(-dt / aiReaction));

    // küçük hata (çok zor olduğu için düşük)
    const error = (Math.random()*2 - 1) * aiAimError;
    const desired = aiMemoryY + error - paddleH/2;

    const diff = desired - right.y;

    // top sağa gidiyorsa saldırgan, sola gidiyorsa pozisyon al
    const aggression = ball.vx > 0 ? 1.0 : 0.70;

    // hız komutu
    const cmd = clamp(diff * 9.0, -aiMaxSpeed, aiMaxSpeed) * aggression;
    right.vy = cmd;

    right.y += right.vy * dt;
    right.y = clamp(right.y, 20, H - 20 - paddleH);
  }

  function awardPoint(toRobot){
    if (toRobot){
      scoreR += 1;
      sRightEl.textContent = scoreR;
      toast("Emre kazandı — Emre sayı attı");
      if (scoreR >= WIN_SCORE) { endGame("Emre"); return; }
      // sayıdan sonra hız az biraz artsın ama oyun kopmasın
      ballBaseSpeed = Math.min(720, ballBaseSpeed + 14);
      resetBall(-1); // topu sola (senin tarafa) başlat
    } else {
      scoreL += 1;
      sLeftEl.textContent = scoreL;
      toast("Asena kazandı — Asena sayı attı");
      if (scoreL >= WIN_SCORE) { endGame("Asena"); return; }
      ballBaseSpeed = Math.min(720, ballBaseSpeed + 14);
      resetBall(+1); // topu sağa (robot tarafa) başlat
    }
  }

  function updateRallySpeed(dt){
    // sayı olmadan ralli uzarsa hızlansın:
    rallyTime += dt;
    if (rallyTime - lastRallyBoostAt >= rallySpeedEverySec){
      lastRallyBoostAt = rallyTime;
      // topun mevcut hızını artır
      const cur = Math.hypot(ball.vx, ball.vy);
      const newSpeed = Math.min(ballMaxSpeed, cur + rallySpeedAdd);

      // yönü koru
      const ang = Math.atan2(ball.vy, ball.vx);
      ball.vx = Math.cos(ang) * newSpeed;
      ball.vy = Math.sin(ang) * newSpeed;
    }
  }

  function updateBall(dt){
    updateRallySpeed(dt);

    ball.x += ball.vx * dt;
    ball.y += ball.vy * dt;

    // üst-alt
    if (ball.y - ballR <= 20) { ball.y = 20 + ballR; ball.vy *= -1; }
    if (ball.y + ballR >= H - 20) { ball.y = (H - 20) - ballR; ball.vy *= -1; }

    // sol raket
    if (ball.x - ballR <= leftX + paddleW &&
        ball.x - ballR >= leftX &&
        ball.y >= left.y && ball.y <= left.y + paddleH &&
        ball.vx < 0) {
      ball.x = leftX + paddleW + ballR;
      reflectFromPaddle(left.y, true);
    }

    // sağ raket
    if (ball.x + ballR >= rightX &&
        ball.x + ballR <= rightX + paddleW &&
        ball.y >= right.y && ball.y <= right.y + paddleH &&
        ball.vx > 0) {
      ball.x = rightX - ballR;
      reflectFromPaddle(right.y, false);
    }

    // sayı
    if (ball.x + ballR < 0) {
      awardPoint(true);   // robot sayı attı
    }
    if (ball.x - ballR > W) {
      awardPoint(false);  // sen sayı attın
    }
  }

  function render(){
    drawCourt();
    drawPaddles();
    drawBall();
    overlayGameOver();
  }

  let last = 0;
  function loop(ts){
    const t = ts / 1000;
    const dt = last ? Math.min(0.03, t - last) : 0;
    last = t;

    if (running && !gameOver){
      updatePlayer(dt);
      updateAI(dt);
      updateBall(dt);
    }
    render();
    requestAnimationFrame(loop);
  }

  fullReset();
  requestAnimationFrame(loop);
})();
</script>
</body>
</html>
